<!DOCTYPE html="en">
<html>
  <head>
    <title>Coverage report</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“ƒ</text></svg>" />
    <style>
      body {
        background: #191919;
        color: #777;
      }

      body, pre, #files, #legend span {
        font-family: 'JetBrains Mono', 'Fira Code', Consolas, Menlo, monospace;
        font-size: 15px;
        font-variant-ligatures: none;
      }

      .point {
        background: none !important;
      }

      #topbar {
        background: #111;
        border-bottom: 1px solid #444;
        font-weight: bold;
        height: 44px;
        position: fixed;
        top: 0; left: 0; right: 0;
      }

      #files {
        background-color: #191919;
        border-radius: 4px;
        border: 1px solid #444;
        color: #ccc;
        padding: 2px;
        font-size: 12px;
      }

      #numbers {
        color: #333;
        cursor: default;
        float: left;
        margin-right: 8px;
        overflow-y: hidden;
        text-align: right;
        user-select: none;
        width: 38px;
      }

      #source {
        margin-top: 50px;
        margin-left: 4px;
        tab-size: 4;
      }

      #nav, #legend {
        float: left;
        margin-left: 10px;
      }

      #legend {
        margin-top: 12px;
      }

      #nav {
        margin-top: 10px;
      }

      #legend span {
        margin: 0 4px;
        background: #222;
        border-radius: 8px;
        cursor: help;
        font-size: 14px;
        padding: 2px 8px;
      }

      @media (max-width: 860px) {
        body, pre, #legend span {
          font-size: 14px;
        }

        #source {
          tab-size: 2;
        }
      }

      @media (max-width: 680px) {
        body, pre, #legend span {
          font-size: 12px;
        }
      }

      .cov0 { color: #dd3d27; }
      .cov1 { color: #929989; }
      .cov2 { color: #909e7f; }
      .cov3 { color: #8fa473; }
      .cov4 { color: #8caa66; }
      .cov5 { color: #89b058; }
      .cov6 { color: #86b548; }
      .cov7 { color: #82bb38; }
      .cov8 { color: #7ec126; }
      .cov9 { color: #79c713; }
      .cov10 { color: #73cd00; }

    </style>
  </head>
  <body>
    <div id="topbar">
      <div id="nav">
        <select id="files">
        <option value="file0">webhooks.go (93.0%)</option>
        </select>
      </div>
      <div id="legend">
        <span title="Code which can't be tested">not tracked</span>
        <span class="cov0" title="Code without test coverage">not covered</span>
        <span class="cov8" title="Code covered by tests">covered</span>
      </div>
    </div>
      <div id="content">
      <div id="numbers">1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8<br/>9<br/>10<br/>11<br/>12<br/>13<br/>14<br/>15<br/>16<br/>17<br/>18<br/>19<br/>20<br/>21<br/>22<br/>23<br/>24<br/>25<br/>26<br/>27<br/>28<br/>29<br/>30<br/>31<br/>32<br/>33<br/>34<br/>35<br/>36<br/>37<br/>38<br/>39<br/>40<br/>41<br/>42<br/>43<br/>44<br/>45<br/>46<br/>47<br/>48<br/>49<br/>50<br/>51<br/>52<br/>53<br/>54<br/>55<br/>56<br/>57<br/>58<br/>59<br/>60<br/>61<br/>62<br/>63<br/>64<br/>65<br/>66<br/>67<br/>68<br/>69<br/>70<br/>71<br/>72<br/>73<br/>74<br/>75<br/>76<br/>77<br/>78<br/>79<br/>80<br/>81<br/>82<br/>83<br/>84<br/>85<br/>86<br/>87<br/>88<br/>89<br/>90<br/>91<br/>92<br/>93<br/>94<br/>95<br/>96<br/>97<br/>98<br/>99<br/>100<br/>101<br/>102<br/>103<br/>104<br/>105<br/>106<br/>107<br/>108<br/>109<br/>110<br/>111<br/>112<br/>113<br/>114<br/>115<br/>116<br/>117<br/>118<br/>119<br/>120<br/>121<br/>122<br/>123<br/>124<br/>125<br/>126<br/>127<br/>128<br/>129<br/>130<br/>131<br/>132<br/>133<br/>134<br/>135<br/>136<br/>137<br/>138<br/>139<br/>140<br/>141<br/>142<br/>143<br/>144<br/>145<br/>146<br/>147<br/>148<br/>149<br/>150<br/>151<br/>152<br/>153<br/>154<br/>155<br/>156<br/>157<br/>158<br/>159<br/>160<br/>161<br/>162<br/>163<br/>164<br/>165<br/>166<br/>167<br/>168<br/>169<br/>170<br/>171<br/>172<br/>173<br/>174<br/>175<br/>176<br/>177<br/>178<br/>179<br/>180<br/>181<br/>182<br/>183<br/>184<br/>185<br/>186<br/>187<br/>188<br/>189<br/>190<br/>191<br/>192<br/>193<br/>194<br/>195<br/>196<br/>197<br/>198<br/>199<br/>200<br/>201<br/>202<br/>203<br/>204<br/>205<br/>206<br/>207<br/>208<br/>209<br/>210<br/>211<br/>212<br/>213<br/>214<br/>215<br/>216<br/>217<br/>218<br/>219<br/>220<br/>221<br/>222<br/>223<br/>224<br/>225<br/>226<br/>227<br/>228<br/>229<br/>230<br/>231<br/>232<br/>233<br/>234<br/>235<br/>236<br/>237<br/>238<br/>239<br/>240<br/>241<br/>242<br/>243<br/>244<br/>245<br/>246<br/>247<br/>248<br/>249<br/>250<br/>251<br/>252<br/>253<br/>254<br/>255<br/>256<br/>257<br/>258<br/>259<br/>260<br/>261<br/>262<br/>263<br/>264<br/>265<br/>266<br/>267<br/>268<br/>269<br/>270<br/>271<br/>272<br/>273<br/>274<br/>275<br/>276<br/></div>
      <div id="source">
      
      <pre class="file" id="file0" data-name="webhooks.go" data-lines="276" data-cover="93.0%">package webhook

// ////////////////////////////////////////////////////////////////////////////////// //
//                                                                                    //
//                         Copyright (c) 2025 ESSENTIAL KAOS                          //
//      Apache License, Version 2.0 &lt;https://www.apache.org/licenses/LICENSE-2.0&gt;     //
//                                                                                    //
// ////////////////////////////////////////////////////////////////////////////////// //

import (
	"crypto/hmac"
	"crypto/sha256"
	"encoding/json"
	"errors"
	"fmt"
	"io"
	"net/http"
	"time"

	"github.com/essentialkaos/ek/v13/hashutil"

	"github.com/essentialkaos/pachca"
)

// ////////////////////////////////////////////////////////////////////////////////// //

const (
	EVENT_NEW    WebhookEvent = "new"
	EVENT_UPDATE WebhookEvent = "update"
	EVENT_DELETE WebhookEvent = "delete"

	EVENT_ADD    WebhookEvent = "add"
	EVENT_REMOVE WebhookEvent = "remove"

	EVENT_INVITE   WebhookEvent = "invite"
	EVENT_CONFIRM  WebhookEvent = "confirm"
	EVENT_SUSPEND  WebhookEvent = "suspend"
	EVENT_ACTIVATE WebhookEvent = "activate"

	EVENT_LINK_SHARED WebhookEvent = "link_shared"

	EVENT_SUBMIT WebhookEvent = "submit"
)

const (
	TYPE_MESSAGE     WebhookType = "message"
	TYPE_REACTION    WebhookType = "reaction"
	TYPE_BUTTON      WebhookType = "button"
	TYPE_CHAT_MEMBER WebhookType = "chat_member"
	TYPE_ORG_MEMBER  WebhookType = "company_member"
	TYPE_VIEW        WebhookType = "view"
)

// ////////////////////////////////////////////////////////////////////////////////// //

// WebhookEvent is type for webhook events
type WebhookEvent string

// WebhookType is type for webhook types
type WebhookType string

// ////////////////////////////////////////////////////////////////////////////////// //

// Webhook is basic webhook object
type Webhook struct {
	Type      WebhookType `json:"type"`
	Timestamp int64       `json:"webhook_timestamp"`
}

// WebhookMessage contains payload of new message webhook
//
// https://crm.pachca.com/dev/getting-started/webhooks/#new-message
type Message struct {
	Webhook
	MessageID       uint              `json:"id"`
	Event           WebhookEvent      `json:"event"`
	EntityType      pachca.EntityType `json:"entity_type"`
	EntityID        uint              `json:"entity_id"`
	Content         string            `json:"content"`
	UserID          uint              `json:"user_id"`
	ChatID          uint              `json:"chat_id"`
	ParentMessageID uint              `json:"parent_message_id"`
	CreatedAt       pachca.Date       `json:"created_at"`
	Thread          *Thread           `json:"thread"`
	Links           []*UnfurlLink     `json:"links"`
}

// Reaction contains payload of reaction webhook
//
// https://crm.pachca.com/dev/getting-started/webhooks/#reaction
type Reaction struct {
	Webhook
	Event     WebhookEvent `json:"event"`
	UserID    uint         `json:"user_id"`
	MessageID uint         `json:"message_id"`
	CreatedAt pachca.Date  `json:"created_at"`
}

// Button contains payload of button webhook
//
// https://crm.pachca.com/dev/getting-started/webhooks/#button
type Button struct {
	Webhook
	Data      string `json:"data"`
	UserID    uint   `json:"user_id"`
	MessageID uint   `json:"message_id"`
	TriggerID string `json:"trigger_id"`
}

// ChatMember contains payload of chat members changes webhook
//
// https://crm.pachca.com/dev/getting-started/webhooks/#chat-member
type ChatMember struct {
	Webhook
	Event     WebhookEvent `json:"event"`
	ChatID    uint         `json:"chat_id"`
	ThreadID  uint         `json:"thread_id"`
	CreatedAt pachca.Date  `json:"created_at"`
	UserIDs   []uint       `json:"user_ids"`
}

// OrgMember contains payload of organization members changes webhook
//
// https://crm.pachca.com/dev/getting-started/webhooks/#company-member
type OrgMember struct {
	Webhook
	Event     WebhookEvent `json:"event"`
	UserIDs   []uint       `json:"user_ids"`
	CreatedAt pachca.Date  `json:"created_at"`
}

// View contains payload from view form
type View struct {
	Webhook
	Event      WebhookEvent    `json:"event"`
	Metadata   string          `json:"private_metadata"`
	CallbackID string          `json:"callback_id"`
	UserID     uint            `json:"user_id"`
	Data       json.RawMessage `json:"data"`
}

// ////////////////////////////////////////////////////////////////////////////////// //

// WebhookThread contains info about message thread
type Thread struct {
	MessageID     uint `json:"message_id"`
	MessageChatID uint `json:"message_chat_id"`
}

// UnfurlLink contains info about link in message to unfurl
type UnfurlLink struct {
	URL    string `json:"url"`
	Domain string `json:"domain"`
}

// ////////////////////////////////////////////////////////////////////////////////// //

var (
	ErrNilRequest  = errors.New("Request is nil")
	ErrNilWebhook  = errors.New("Webhook is nil")
	ErrEmptyData   = errors.New("Webhook has no data")
	ErrInvalidSig  = errors.New("Webhook has invalid signature")
	ErrNoSignature = errors.New("Webhook has no signature")
)

// MaxWebhookSize is the maximum size of the webhook payload
var MaxWebhookSize int64 = 1024 * 1024

// ////////////////////////////////////////////////////////////////////////////////// //

// Read reads webhook data from HTTP request
func Read(r *http.Request) (any, error) <span class="cov8">{
	if r == nil || r.Body == nil </span><span class="cov8">{
		return nil, ErrNilRequest
	}</span>

	<span class="cov8">rr := io.LimitReader(r.Body, MaxWebhookSize)
	data, err := io.ReadAll(rr)

	if err != nil </span><span class="cov0">{
		return nil, fmt.Errorf("Can't read webhook data: %w", err)
	}</span>

	<span class="cov8">return Decode(data)</span>
}

// ReadSigned reads webhook data from HTTP request and validates signature
func ReadSigned(r *http.Request, secret string) (any, error) <span class="cov8">{
	switch </span>{
	case r == nil || r.Body == nil:<span class="cov8">
		return nil, ErrNilRequest</span>
	case r.Header.Get("Pachca-Signature") == "":<span class="cov8">
		return nil, ErrNoSignature</span>
	}

	<span class="cov8">rr := io.LimitReader(r.Body, MaxWebhookSize)
	data, err := io.ReadAll(rr)

	if err != nil </span><span class="cov0">{
		return nil, fmt.Errorf("Can't read webhook data: %w", err)
	}</span>

	<span class="cov8">mac := hmac.New(sha256.New, []byte(secret))
	_, err = mac.Write(data)

	if err != nil </span><span class="cov0">{
		return nil, fmt.Errorf("Can't calculate webhook HMAC hash: %w", err)
	}</span>

	<span class="cov8">if !hashutil.Sum(mac).EqualString(r.Header.Get("Pachca-Signature")) </span><span class="cov8">{
		return nil, ErrInvalidSig
	}</span>

	<span class="cov8">return Decode(data)</span>
}

// Decode unmarshals webhook JSON data
func Decode(data []byte) (any, error) <span class="cov8">{
	w := &amp;Webhook{}
	err := json.Unmarshal(data, w)

	if err != nil </span><span class="cov8">{
		return nil, fmt.Errorf("Can't parse webhook JSON: %w", err)
	}</span>

	<span class="cov8">var ww any

	switch w.Type </span>{
	case TYPE_MESSAGE:<span class="cov8">
		ww = &amp;Message{}</span>
	case TYPE_REACTION:<span class="cov8">
		ww = &amp;Reaction{}</span>
	case TYPE_BUTTON:<span class="cov8">
		ww = &amp;Button{}</span>
	case TYPE_CHAT_MEMBER:<span class="cov8">
		ww = &amp;ChatMember{}</span>
	case TYPE_ORG_MEMBER:<span class="cov8">
		ww = &amp;OrgMember{}</span>
	case TYPE_VIEW:<span class="cov8">
		ww = &amp;View{}</span>
	default:<span class="cov8">
		return nil, fmt.Errorf("Unsupported webhook type %q", w.Type)</span>
	}

	<span class="cov8">json.Unmarshal(data, ww)

	return ww, nil</span>
}

// ////////////////////////////////////////////////////////////////////////////////// //

// Age returns age of webhook
func (w *Webhook) Age() time.Duration <span class="cov8">{
	if w == nil </span><span class="cov8">{
		return 0
	}</span>

	<span class="cov8">return time.Since(time.Unix(w.Timestamp, 0))</span>
}

// ////////////////////////////////////////////////////////////////////////////////// //

// UnmarshalData unmarshals webhook data
func (w *View) UnmarshalData(v any) error <span class="cov8">{
	switch </span>{
	case w == nil:<span class="cov8">
		return ErrNilWebhook</span>
	case len(w.Data) == 0:<span class="cov8">
		return ErrEmptyData</span>
	}

	<span class="cov8">return json.Unmarshal(w.Data, v)</span>
}

// ////////////////////////////////////////////////////////////////////////////////// //
</pre>
      
      </div>
     </div>
  </body>
  <script>
    var files
    var current

    function main() {
      files = document.getElementById('files');
      current = document.getElementById('file0');

      if (window.location.hash != "") {
        var selectedFile = window.location.hash.substr(1);
        swapFiles('file' + selectedFile);
        files.selectedIndex = parseInt(selectedFile);
      } else {
        updateViewport();
        updateInfo(current.id);
      }

      files.addEventListener('change', onChange, false);
    }

    function onChange() {
      swapFiles(files.value);
    }

    function swapFiles(file) {
      current.style.display = 'none';
      current = document.getElementById(file);
      current.style.display = 'block';

      updateViewport();
      updateInfo(file);

      window.scrollTo(0, 0);
    }

    function updateInfo(file) {
      window.location.hash = file.substr(4);
      document.title = current.getAttribute('data-cover') + ' â€¢ ' + current.getAttribute('data-name');
    }

    function updateViewport() {
      document.getElementById('numbers').style.maxHeight = current.offsetHeight;
    }

    main();
  </script>
</html>
